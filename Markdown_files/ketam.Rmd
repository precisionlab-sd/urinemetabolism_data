### Download packages

```{r}
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(ggfittext)
library(skimr)
library(here)
library(patchwork)
library(stringi)
library(lubridate)
library(eeptools)
library(referenceIntervals)
library(robustbase)
library(MASS)
library(boot)
library(data.table)
library(car)
```

### Retrieve processed main data

```{r}
data <- read_csv(gsub("Markdown_files", "", here("Processed CSV", "ketam_main.csv")))
# add 'logratios' column (update for each pair)
data$logratios <- data$log_ketam_ratio

titlestr = "Norketamine/Ketamine"
savestr = "ketam"
drugname = "Ketamine"
```

### Format dates
```{r}
data$Birth_Date = as.Date(data$Birth_Date,"%d/%m/%Y") # convert to date format
data$sample_acquisition_time = as.Date(data$sample_acquisition_time,"%m/%d/%Y") # convert to date format
```

### Read in drug-drug interaction (DDI) filters

```{r}
DDIlimits <- read.csv(gsub("Markdown_files", "", here("DDI_limits.csv")), header=FALSE)
```

### Filter data for DDIs

```{r}
# Initialize as main data
data_DDIfilt <- data.frame(data, check.names=FALSE)

# Loop through each DDI condition and filter
for(i in 1:nrow(DDIlimits)) {
  cond = as.symbol(DDIlimits$V1[i])
  data_DDIfilt_temp <- data_DDIfilt |>
    filter(get(cond) < DDIlimits$V2[i])
  data_DDIfilt <- data.frame(data_DDIfilt_temp, check.names=FALSE)
}
```

### Generate 95% and genetic-based intervals for log-ratios from DDI-filtered data and build histogram
#### Enter genetic slow and fast quantiles (from Zhu, et al.)

```{r}
# Replace here with log-ratio of interest
logratios = data_DDIfilt$logratios

# ketamine uses the CYP2B6, CYP3A4/5 enzymes
slow_quant_1 <- 0.091
fast_quant_1 <- 1.00
slow_quant_2 <- (1-0.921)/2
fast_quant_2 <- 0.921+(1-0.921)/2

# 95% interval
LL_95 <- quantile(logratios, probs = 0.025)
UL_95 <- quantile(logratios, probs = 0.975)

# Genetic-based interval
LL_gene_1 <- quantile(logratios, probs = slow_quant_1)
UL_gene_1 <- quantile(logratios, probs = fast_quant_1)
LL_gene_2 <- quantile(logratios, probs = slow_quant_2)
UL_gene_2 <- quantile(logratios, probs = fast_quant_2)

# Generate histogram and add vertical lines indicating the intervals
bw = 0.05 #bin width
intw = 1.2 #line width for intervals
intlabh1 = 50 #height position for labels
intlabh2 = 40
intlabh3 = 30
hzoff = 0.2 #offset for labels from vertical line 
labsize = 3.5 #label text size
labboxwidth1 = 20 #label box width
labboxwidth2 = 20 #label box width
ndata = length(logratios)
genestr1 = "genetic-based (CYP2B6):"
genestr2 = "genetic-based (CYP3A4):"
xctr = median(logratios)
xwdth = 2.0
xmin = xctr-xwdth # lower x range
xmax = xctr+xwdth # upper x range
col1 = "blue" # colors for intervals
col2 = "red"
col3 = "orange"


# function for wrapping long labels
wrapper <- function(x, ...) paste(strwrap(x, ...), collapse = "\n")

ggplot(data.frame(logratios), aes(x = logratios)) +
  geom_histogram(binwidth=bw) +
  geom_density(aes(y=..density..*(bw*ndata)), linewidth=1.0) +
  geom_vline(xintercept=LL_95, linetype="dashed",color=col1,size=intw) +
  annotate("text",x=LL_95-hzoff, y=intlabh1, hjust=1, size=labsize, 
           label=wrapper(paste("lower 95%:", round(LL_95,3)), width=labboxwidth1), color=col1) +
  geom_vline(xintercept=UL_95, linetype="dashed",color=col1,size=intw) +
  annotate("text",x=UL_95+hzoff, y=intlabh1, hjust=0, size=labsize, 
           label=wrapper(paste("upper 95%:", round(UL_95,3)),width=labboxwidth1), color=col1) +
  geom_vline(xintercept=LL_gene_1, linetype="dashed",color=col2,size=intw) +
  annotate("text",x=LL_gene_1-hzoff, y=intlabh2, hjust=1, size=labsize, 
           label=wrapper(paste("lower", genestr1, round(LL_gene_1,3)),width=labboxwidth2), color=col2) +
  geom_vline(xintercept=LL_gene_2, linetype="dashed",color=col3,size=intw) +
  annotate("text",x=LL_gene_2-hzoff, y=intlabh3, hjust=1, size=labsize, label=wrapper(paste("lower", genestr2, round(LL_gene_2,3)),width=labboxwidth2), color=col3) +
  geom_vline(xintercept=UL_gene_2, linetype="dashed",color=col3,size=intw) +
  annotate("text",x=UL_gene_2+hzoff, y=intlabh3, hjust=0, size=labsize,
           label=wrapper(paste("upper", genestr2, round(UL_gene_2,3)),width=labboxwidth2), color=col3) +
  ggtitle(substitute(paste("Histogram of ", log[10], " ", nn, " ratios"), list(nn=titlestr))) +
  #ggtitle(paste("Histogram of log", titlestr, "ratios")) +
  labs(x= substitute(paste(log[10], " ", nn," ratios"), list(nn=titlestr)), y="Frequency") +  
  theme_clean() + xlim(xmin,xmax) + 
  scale_y_continuous(expand = expansion(mult = c(0, 0))) # collapse the height

ggsave(gsub("Markdown_files", "", here("Histograms_simple", paste(savestr,"_simplehist.png",sep=""))), dpi=500)
```

### Produce interval table; include all genotypes for simplicity
```{r}
lrats = data_DDIfilt$logratios
lo_col = c(quantile(lrats, probs=0.025), quantile(lrats, probs=0.091),
           quantile(lrats, probs=0.02), quantile(lrats, probs=0.024),
           quantile(lrats, probs=0.054), quantile(lrats, probs=(1-0.921)/2))
lo_norm_col = c(exp(lo_col))
hi_col = c(quantile(lrats, probs=0.975), NA, NA,
           quantile(lrats, probs=1-0.303),
           quantile(lrats, probs=1-0.018), quantile(lrats, probs=1-(1-0.921)/2))
hi_norm_col = c(exp(hi_col))

genonames = c("95% interval", "2B6", "2C9", "2C19", "2D6", "3A4")

medvec = rep("", length=length(genonames))
medvec[1] = median(exp(lrats))
meanvec = rep("", length=length(genonames))
meanvec[1] = mean(exp(lrats))

dt_norm = data.table(
  Interval_Name = genonames,
  Low_interval_log = round(lo_col,4),
  High_interval_log = round(hi_col,4),
  Low_interval_norm = round(lo_norm_col,4),
  High_interval_norm = round(hi_norm_col,4),
  Median = medvec,
  Mean = meanvec
)

write.csv(dt_norm, row.names = FALSE, 
          file=gsub("Markdown_files", "", here("Tables_Ref_Int", paste(savestr,"_refint.csv",sep=""))))
```

### Generate and plot bootstrap intervals for the 95% quantiles 
```{r}
R = 1000 # number of bootstrap samples

set.seed(5)
# 0.025 quantile
lower_95_boot = c()
for (r in 1:R) {
  newquant = quantile(sample(logratios, size=length(logratios), replace=TRUE),probs = 0.025)
    lower_95_boot = c(lower_95_boot, newquant)  
}
# Provide quantile range for central 99%
lo_lower95_boot = quantile(lower_95_boot, probs=0.005) 
hi_lower95_boot = quantile(lower_95_boot, probs=0.995) 

# 0.975 quantile
upper_95_boot = c()
for (r in 1:R) {
  newquant = quantile(sample(logratios, size=length(logratios), replace=TRUE),probs = 0.975)
    upper_95_boot = c(upper_95_boot, newquant)  
}
# Provide quantile range for central 99%
lo_upper95_boot = quantile(upper_95_boot,probs=0.005) # Provide the quantile range
hi_upper95_boot = quantile(upper_95_boot, probs=0.995) 

# re-plot histogram with range included

ggplot(data.frame(logratios), aes(x = logratios)) +
  geom_histogram(binwidth=bw) +
  geom_density(aes(y=..density..*(bw*ndata)), linewidth=1.0) +
  geom_vline(xintercept=LL_95, linetype="dashed",color=col1,size=intw) +
  annotate("text",x=LL_95-2*hzoff, y=intlabh1, hjust=1, size=labsize, 
           label=wrapper(paste("lower 95% bootstrap range"), width=labboxwidth1), color=col1) +
  geom_vline(xintercept=UL_95, linetype="dashed",color=col1,size=intw) +
  annotate("text",x=UL_95+2.5*hzoff, y=intlabh1, hjust=0, size=labsize, 
           label=wrapper(paste("upper 95% bootstrap range"),width=labboxwidth1), color=col1) +
  annotate("rect", xmin=lo_lower95_boot, xmax=hi_lower95_boot,ymin=0, ymax=Inf, alpha=0.3, fill=col1) +
  annotate("rect", xmin=lo_upper95_boot, xmax=hi_upper95_boot, ymin=0, ymax=Inf, alpha=0.3, fill=col1) +
  ggtitle(substitute(paste("Histogram of ", log[10], " ", nn, " ratios"), list(nn=titlestr))) +
  #ggtitle(paste("Histogram of log", titlestr, "ratios")) +
  labs(x= substitute(paste(log[10], " ", nn," ratios"), list(nn=titlestr)), y="Frequency") + 
  theme_clean() + xlim(xmin,xmax) + 
  scale_y_continuous(expand = expansion(mult = c(0, 0)))

ggsave(gsub("Markdown_files", "", here("Histograms_bootstrap", paste(savestr,"_boothist.png",sep=""))), dpi=500)
```


### Generate and plot 95% quantiles versus year of data 
```{r}
# Separate the filtered data by year
#data_DDIfilt$sample_acquisition_time = as.Date(data_DDIfilt$sample_acquisition_time,"%m/%d/%Y") # convert to date format

data_DDIfilt_2020 = data_DDIfilt[which(data_DDIfilt$sample_acquisition_time<"2021-01-01"),]
data_DDIfilt_2021 = data_DDIfilt[which(data_DDIfilt$sample_acquisition_time<"2022-01-01" & data_DDIfilt$sample_acquisition_time>"2020-12-31"),]
data_DDIfilt_2022 = data_DDIfilt[which(data_DDIfilt$sample_acquisition_time<"2023-01-01" & data_DDIfilt$sample_acquisition_time>"2021-12-31"),]
data_DDIfilt_2023 = data_DDIfilt[which(data_DDIfilt$sample_acquisition_time<"2024-01-01" & data_DDIfilt$sample_acquisition_time>"2022-12-31"),]
data_DDIfilt_2024 = data_DDIfilt[which(data_DDIfilt$sample_acquisition_time<"2025-01-01" & data_DDIfilt$sample_acquisition_time>"2023-12-31"),]

# Check the data is appropriately spliced
print(dim(data_DDIfilt_2020)[1] + dim(data_DDIfilt_2021)[1] + dim(data_DDIfilt_2022)[1] + dim(data_DDIfilt_2023)[1] + dim(data_DDIfilt_2024)[1])
print(dim(data_DDIfilt)[1])

# Get 95% intervals for each year
LL_95_2020 <- quantile(data_DDIfilt_2020$logratios, probs = 0.025)
UL_95_2020 <- quantile(data_DDIfilt_2020$logratios, probs = 0.975)
LL_95_2021 <- quantile(data_DDIfilt_2021$logratios, probs = 0.025)
UL_95_2021 <- quantile(data_DDIfilt_2021$logratios, probs = 0.975)
LL_95_2022 <- quantile(data_DDIfilt_2022$logratios, probs = 0.025)
UL_95_2022 <- quantile(data_DDIfilt_2022$logratios, probs = 0.975)
LL_95_2023 <- quantile(data_DDIfilt_2023$logratios, probs = 0.025)
UL_95_2023 <- quantile(data_DDIfilt_2023$logratios, probs = 0.975)
LL_95_2024 <- quantile(data_DDIfilt_2024$logratios, probs = 0.025)
UL_95_2024 <- quantile(data_DDIfilt_2024$logratios, probs = 0.975)

yeararr = c(2020,2021,2022,2023,2024)
LLarr = c(LL_95_2020, LL_95_2021, LL_95_2022, LL_95_2023, LL_95_2024)
ULarr = c(UL_95_2020, UL_95_2021, UL_95_2022, UL_95_2023, UL_95_2024)

# generate range plot
tempstrvec = c("Reference intervals generated by yearly data, 2020-2024", paste(titlestr,"ratios") )
ggplot(data.frame(yeararr, LLarr,ULarr), aes(yeararr, LLarr)) + geom_errorbar(aes(ymin=LLarr, ymax=ULarr), width=0.4, size=1.2)  +
  ggtitle(label = tempstrvec[1], subtitle=bquote(log[10]~.(tempstrvec[2]))) +
  labs(x="Year", y= substitute(paste(log[10], " ", nn," ratios"), list(nn=titlestr))) +  
  theme_clean()  
  
ggsave(gsub("Markdown_files", "", here("Histograms_yearly", paste(savestr,"_yearly.png",sep=""))), dpi=400)
```

### Examine DDIs and produce whisker plot and table
```{r}
list_logratios = vector(mode="list", length=nrow(DDIlimits)+1) # Add one for "no DDI"
DDInames = c()

DDI_Npats = c()
DDI_Nobs = c()
DDI_medians = c()
DDI_means = c()
DDI_LQRs = c()
DDI_UQRs = c()
DDI_stdevs = c()
DDI_stdevs_exp = c()

#Loop through each DDI, creating new filtered data set
for(currDDI in 1:nrow(DDIlimits)) {
  DDInames = c(DDInames, DDIlimits$V1[currDDI])
  # Initialize as main data
  data_currDDI <- data.frame(data, check.names=FALSE)
  for(i in 1:nrow(DDIlimits)) {
    if (i!=currDDI) { # filter if not on current DDI of interest
      cond = as.symbol(DDIlimits$V1[i])
      data_DDIfilt_temp <- data_currDDI |>
        filter(get(cond) < DDIlimits$V2[i])
      data_currDDI <- data.frame(data_DDIfilt_temp, check.names=FALSE)
    }
  }
  # Now only keep records with sufficient currDDI
  cond = as.symbol(DDIlimits$V1[currDDI])
  data_DDIfilt_temp <- data_currDDI |>
        filter(get(cond) >= DDIlimits$V2[currDDI])
  data_currDDI <- data.frame(data_DDIfilt_temp, check.names=FALSE)
  
  # How many unique patients, and how many total obsvns?
  DDI_Npats = c(DDI_Npats, length(unique(data_currDDI$Patient_ID)))
  DDI_Nobs = c(DDI_Nobs, nrow(data_currDDI))
  
  # Other stats
  DDI_medians = c(DDI_medians, median(data_currDDI$logratios))
  DDI_means = c(DDI_means, mean(data_currDDI$logratios))
  DDI_LQRs = c(DDI_LQRs, quantile(data_currDDI$logratios, 0.25))
  DDI_UQRs = c(DDI_UQRs, quantile(data_currDDI$logratios, 0.75))
  DDI_stdevs = c(DDI_stdevs, sd(data_currDDI$logratios))
  DDI_stdevs_exp = c(DDI_stdevs_exp, sd(exp(data_currDDI$logratios)))
  
  list_logratios[[currDDI]] = data_currDDI$logratios
}
# Add "no interaction" logratios to list
list_logratios[[currDDI+1]] = data_DDIfilt$logratios
DDInames_expr = c(DDInames, expression(bold("No interaction")))
DDInames = c(DDInames, "No interaction")
names(list_logratios) <- DDInames

# Count unique and obsvns
DDI_Npats = c(DDI_Npats, length(unique(data_DDIfilt$Patient_ID)))
DDI_Nobs = c(DDI_Nobs, nrow(data_DDIfilt))
# Add stats
DDI_medians = c(DDI_medians, median(data_DDIfilt$logratios))
DDI_means = c(DDI_means, mean(data_DDIfilt$logratios))
DDI_LQRs = c(DDI_LQRs, quantile(data_DDIfilt$logratios, 0.25))
DDI_UQRs = c(DDI_UQRs, quantile(data_DDIfilt$logratios, 0.75))
DDI_stdevs = c(DDI_stdevs, sd(data_DDIfilt$logratios))
DDI_stdevs_exp = c(DDI_stdevs_exp, sd(exp(data_DDIfilt$logratios)))

# make box plot
gapinds = c(2,4,6,12,20)
list_lr_plot = vector(mode="list", length=nrow(DDIlimits)+1+length(gapinds))
nextlistind = 1
for (j in 1:length(list_lr_plot)) {
  if (j %in% gapinds) {
    list_lr_plot[[j]] <- c(NA)
  } else {
    list_lr_plot[[j]] <- list_logratios[[nextlistind]]
    nextlistind = nextlistind + 1
  }
}

listDF = data.frame(lapply(list_lr_plot,"length<-", max(lengths(list_lr_plot))),
                    check.names = FALSE) # fill blanks with NA


tiff(gsub("Markdown_files", "",here("Boxplots_DDI", paste(savestr,"_box_DDI.tiff",sep=""))),
    width=7.25,height=4.5,units="in", res=400)

dcol1 = "royalblue4"
dcol2 = "aquamarine4"
lcol1 = "royalblue1"
lcol2 = "aquamarine2"

DDIlabels = rep("", length = length(DDInames) + length(gapinds))
currnameind = 1
for (i in 1:length(DDIlabels)) {
  if (!(i %in% gapinds)) {
    DDIlabels[i] <- DDInames[currnameind]
    currnameind = currnameind + 1
  }
}

bordervec = c(rep(c(dcol1, dcol2), floor(length(DDIlabels)/2)), "black")
colvec = c(rep(c(lcol1, lcol2), floor(length(DDIlabels)/2)), "darkgray")

tempstr = c(paste(titlestr,"ratios"))
par(cex.lab=0.85, cex.main=0.92, mar=c(6.1, 8, 4.1, 3.1), cex.axis=0.8)
boxplot.matrix(as.matrix(listDF), outline = FALSE, notch = TRUE, las=TRUE,
               #names=DDIlabels, 
               yaxt = "n",
               main=substitute(bold(paste("Boxplots of ", log[10], " ", nn, " ratios with drug interactions")), list(nn=titlestr)),  font.main = 5,
               #main=paste("Boxplots of log",titlestr,"ratios with drug interactions"), 
               boxwex=0.75, xlab=bquote(log[10]~.(tempstr[1])), horizontal=TRUE,
               border = bordervec, col = colvec)
axis(2, at=setdiff(seq(1:length(DDIlabels)),gapinds), labels=DDInames, las=2, cex.axis=0.55)

dev.off()
```

### Generate table of statistics
```{r}
# Reverse order of DDInames, Npats and Nobsv from above (to match boxplot)
tablenames = rev(DDInames)
Npatient = rev(DDI_Npats)
Nobserv = rev(DDI_Nobs)
meds = rev(DDI_medians)
LQRs = rev(DDI_LQRs)
UQRs = rev(DDI_UQRs)
means = rev(DDI_means)
stds = rev(DDI_stdevs)
stds_norm = rev(DDI_stdevs_exp)

# Get t-test p-values
sig_mim = 1E-50 # Lowest considered p-value threshold, for ease of printing
t_test_vals = c("NA")
for(currDDI in nrow(DDIlimits):1) {
  g1 = list_logratios[[nrow(DDIlimits)+1]]
  g2 = list_logratios[[currDDI]]
  # Check if variances are equal
  ttestobj = t.test(g1, g2, var.equal=FALSE)
  if (ttestobj$p.value < sig_mim){
    t_test_vals = c(t_test_vals, paste("<", sig_mim, sep=" "))
  } else {
    t_test_vals = c(t_test_vals, signif(ttestobj$p.value, 3))
  }
}

dt_log = data.table(
  Name = tablenames,
  Median = round(meds,4),
  Mean = round(means,4),
  StDev = round(stds,4),
  LQ = round(LQRs,4),
  UQ = round(UQRs,4),
  N_patients = Npatient,
  N_observations = Nobserv,
  p_value = t_test_vals
)

dt_norm = data.table(
  Name = tablenames,
  Median = round(exp(meds),4),
  Mean = round(exp(means),4),
  StDev = round(stds_norm,4),
  LQ = round(exp(LQRs),4),
  UQ = round(exp(UQRs),4),
  N_patients = Npatient,
  N_observations = Nobserv,
  p_value = t_test_vals
)

# Produce row of +, -, and 0 for the presence of significant effects
DDIeffnames = tablenames[-1]
effstr = c()
for (j in 1:length(t_test_vals[-1])){
  if (t_test_vals[j+1]==paste("<", sig_mim, sep=" ")) {
    currval = 0
  } else {
    currval = as.numeric(t_test_vals[j+1])
  }
  if (currval > 0.05) { # Insignificant effect
    effstr = c(effstr, 0)
  } else { # Significant effect
    if (means[j+1] > means[1]) { # Positive
      effstr = c(effstr, "+")  
    } else {
      effstr = c(effstr, "-")
    }
  }
}

dt_eff = data.table(
  Name = titlestr,
  Ratio = paste(signif(lo_norm_col[1],4),"-",signif(hi_norm_col[1],4))
)
for (i in 1:length(DDIeffnames)) {
  dt_eff[,DDIeffnames[i]] = effstr[i]
}

write.csv(dt_log, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_DDI", paste(savestr,"_log.csv",sep=""))))

write.csv(dt_norm, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_DDI", paste(savestr,"_norm.csv",sep=""))))

write.csv(dt_eff, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_DDI_effect", paste(savestr,"_eff.csv",sep=""))))
```

### Examine any effects correlated with aging
```{r}
# Create data frame for age analysis that drops patients whose birth dates are not entered or with sample dates preceding birth dates, which are assumed to be data entry errors
data_DDIfilt_age <- data_DDIfilt %>%
  filter(!is.na(Birth_Date), Birth_Date<sample_acquisition_time)

# Add ageattest column
data_DDIfilt_age <- data_DDIfilt_age |>
   mutate(ageattest = age_calc(Birth_Date, enddate=sample_acquisition_time, units="years"))

# Put vector of lower part of age intervals here
agebins1 = c(20,40,65)
agebins2 = seq(20, 85, by=5)

agebins = agebins1
list_logratios = vector(mode="list", length=length(agebins)) # store values
age_Npats = c()
age_Nobs = c()
age_LQRs = c()
age_UQRs = c()
age_meds = c()
age_means = c()
age_stds = c()
age_stds_norm = c()
for (i in 1:length(agebins)) {
  # Iterate through each age group and grab 95% interval values
  if(i < length(agebins)) {
    data_curragebin = data_DDIfilt_age[which(data_DDIfilt_age$ageattest>agebins[i] & data_DDIfilt_age$ageattest<agebins[i+1]),]
  } else {
    data_curragebin = data_DDIfilt_age[which(data_DDIfilt_age$ageattest>agebins[i]),]
  }
  age_Npats = c(age_Npats, length(unique(data_curragebin$Patient_ID)))
  age_Nobs = c(age_Nobs, nrow(data_curragebin))
  age_means = c(age_means, mean(data_curragebin$logratios))
  age_meds = c(age_meds, median(data_curragebin$logratios))
  age_LQRs = c(age_LQRs, quantile(data_curragebin$logratios, probs=0.25))
  age_UQRs = c(age_UQRs, quantile(data_curragebin$logratios, probs=0.75))
  age_stds = c(age_stds, sd(data_curragebin$logratios))
  age_stds_norm = c(age_stds_norm, sd(exp(data_curragebin$logratios)))
  list_logratios[[i]] = data_curragebin$logratios
  #LL_95_currage <- quantile(data_curragebin$logratios, probs = 0.025)
  #UL_95_currage <- quantile(data_curragebin$logratios, probs = 0.975)
}

# Generate plot of intervals across ages
listDF = data.frame(lapply(rev(list_logratios),"length<-", max(lengths(list_logratios))),
                    check.names = FALSE) # fill blanks with NA
# Generate vector of names
agenames = c()
for (j in 1:length(agebins)) {
  if (j < length(agebins)) {
    agenames = c(agenames, paste(as.character(agebins[j]), as.character(agebins[j+1]), sep="-"))
  } else {
    agenames = c(agenames, paste(as.character(agebins[j]), "+", sep=""))
  }
}

tiff(gsub("Markdown_files", "",here("Boxplots_age", paste(savestr,"_wide.tiff",sep=""))),
    width=7.25,height=4.5,units="in", res=400)

tempstr = c(paste(titlestr,"ratios"))
par(cex.lab=0.85, cex.main=0.92, mar=c(6.1, 8, 4.1, 3.1), cex.axis=0.7)
boxplot.matrix(as.matrix(listDF), outline = FALSE, notch = TRUE, las=TRUE,
               names=rev(agenames),
               main=substitute(bold(paste("Boxplots of ", log[10], " ", nn, " ratios versus age groups")), list(nn=titlestr)),
               boxwex=0.85, xlab=bquote(log[10]~.(tempstr[1])), horizontal=TRUE, ylab=paste("Age","group"),
               border = rep(c("brown4"), length(agebins)),
               col = rep(c("brown3"),length(agebins)))

dev.off()
```

### Generate table of statistics
```{r}
# Create 95% CIs for difference in means from first age bin
ageCIs = c("NA")
for (i in 2:length(list_logratios)){
  tobj = t.test(list_logratios[[1]], list_logratios[[i]], var.equal = FALSE)
  ageCIs = c(ageCIs, paste("(",tobj$conf.int[1]," , ",tobj$conf.int[2],")",sep=""))
}

# Reverse order of DDInames, Npats and Nobsv from above (to match boxplot)
tablenames = agenames
Npatient = age_Npats
Nobserv = age_Nobs
meds = age_meds
means = age_means
LQRs = age_LQRs
UQRs = age_UQRs
stds = age_stds
stds_norm = age_stds_norm

dt_log = data.table(
  Name = tablenames,
  Median = round(meds,4),
  Mean = round(means,4),
  StDev = round(stds,4),
  LQ = round(LQRs,4),
  UQ = round(UQRs,4),
  N_patients = Npatient,
  N_observations = Nobserv,
  Conf_Int = ageCIs
)

dt_norm = data.table(
  Name = tablenames,
  Median = round(exp(meds),4),
  Mean = round(exp(means),4),
  StDev = round(stds_norm,4),
  LQ = round(exp(LQRs),4),
  UQ = round(exp(UQRs),4),
  N_patients = Npatient,
  N_observations = Nobserv
)

write.csv(dt_log, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_age", paste(savestr,"_wide.csv",sep=""))))

write.csv(dt_norm, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_age", paste(savestr,"_wide_norm.csv",sep=""))))
```

#### Repeat this process for another slicing of age bins
```{r}
agebins = agebins2
list_logratios = vector(mode="list", length=length(agebins)) # store values
age_Npats = c()
age_Nobs = c()
age_LQRs = c()
age_UQRs = c()
age_meds = c()
age_means = c()
age_stds = c()
age_stds_norm = c()
for (i in 1:length(agebins)) {
  # Iterate through each age group and grab 95% interval values
  if(i < length(agebins)) {
    data_curragebin = data_DDIfilt_age[which(data_DDIfilt_age$ageattest>agebins[i] & data_DDIfilt_age$ageattest<agebins[i+1]),]
  } else {
    data_curragebin = data_DDIfilt_age[which(data_DDIfilt_age$ageattest>agebins[i]),]
  }
  age_Npats = c(age_Npats, length(unique(data_curragebin$Patient_ID)))
  age_Nobs = c(age_Nobs, nrow(data_curragebin))
  age_means = c(age_means, mean(data_curragebin$logratios))
  age_meds = c(age_meds, median(data_curragebin$logratios))
  age_LQRs = c(age_LQRs, quantile(data_curragebin$logratios, probs=0.25))
  age_UQRs = c(age_UQRs, quantile(data_curragebin$logratios, probs=0.75))
  age_stds = c(age_stds, sd(data_curragebin$logratios))
  age_stds_norm = c(age_stds_norm, sd(exp(data_curragebin$logratios)))
  list_logratios[[i]] = data_curragebin$logratios
  #LL_95_currage <- quantile(data_curragebin$logratios, probs = 0.025)
  #UL_95_currage <- quantile(data_curragebin$logratios, probs = 0.975)
}

# Generate plot of intervals across ages
listDF = data.frame(lapply(rev(list_logratios),"length<-", max(lengths(list_logratios))),
                    check.names = FALSE) # fill blanks with NA
# Generate vector of names
agenames = c()
for (j in 1:length(agebins)) {
  if (j < length(agebins)) {
    agenames = c(agenames, paste(as.character(agebins[j]), as.character(agebins[j+1]), sep="-"))
  } else {
    agenames = c(agenames, paste(as.character(agebins[j]), "+", sep=""))
  }
}

tiff(gsub("Markdown_files", "",here("Boxplots_age", paste(savestr,"_narrow.tiff",sep=""))),
    width=7.25,height=4.5,units="in", res=400)

tempstr = c(paste(titlestr,"ratios"))
par(cex.lab=0.85, cex.main=0.92, mar=c(6.1, 8, 4.1, 3.1), cex.axis=0.7)
boxplot.matrix(as.matrix(listDF), outline = FALSE, notch = TRUE, las=TRUE,
               names=rev(agenames),
               main=substitute(bold(paste("Boxplots of ", log[10], " ", nn, " ratios versus age groups")), list(nn=titlestr)), 
               boxwex=0.85, xlab=bquote(log[10]~.(tempstr[1])), horizontal=TRUE, ylab=paste("Age","group"),
               border = rep(c("brown4"), length(agebins)),
               col = rep(c("brown3"),length(agebins)))

dev.off()
```

### Generate table of statistics
```{r}
# Create 95% CIs for difference in means from first age bin
ageCIs = c("NA")
for (i in 2:length(list_logratios)){
  tobj = t.test(list_logratios[[1]], list_logratios[[i]], var.equal = FALSE)
  ageCIs = c(ageCIs, paste("(",tobj$conf.int[1]," , ",tobj$conf.int[2],")",sep=""))
}

# Reverse order of DDInames, Npats and Nobsv from above (to match boxplot)
tablenames = agenames
Npatient = age_Npats
Nobserv = age_Nobs
meds = age_meds
means = age_means
LQRs = age_LQRs
UQRs = age_UQRs
stds = age_stds
stds_norm = age_stds_norm

dt_log = data.table(
  Name = tablenames,
  Median = round(meds,4),
  Mean = round(means,4),
  StDev = round(stds,4),
  LQ = round(LQRs,4),
  UQ = round(UQRs,4),
  N_patients = Npatient,
  N_observations = Nobserv,
  Conf_Int = ageCIs
)

dt_norm = data.table(
  Name = tablenames,
  Median = round(exp(meds),4),
  Mean = round(exp(means),4),
  StDev = round(stds_norm,4),
  LQ = round(exp(LQRs),4),
  UQ = round(exp(UQRs),4),
  N_patients = Npatient,
  N_observations = Nobserv
)

write.csv(dt_log, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_age", paste(savestr,"_narrow.csv",sep=""))))

write.csv(dt_norm, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_age", paste(savestr,"_narrow_norm.csv",sep=""))))
```

### Examine saturation kinetics
```{r}
# Get drug name as variable and generate histogram
drugcol = grep(paste("^",drugname,"$",sep=""), colnames(data_DDIfilt))
numgroups = 10

tiff(gsub("Markdown_files", "", here("Histograms_druglevel", paste(savestr,"_druglevel.tiff",sep=""))),
    width=7.25,height=4.5,units="in", res=400)

tempstr = c(paste(drugname, "levels"))
par(cex.lab=0.85, cex.main=0.92, mar=c(6.1, 8, 4.1, 3.1), cex.axis=0.7)
hist(log10(data_DDIfilt[,drugcol]),
     main=substitute(bold(paste("Histogram of ", log[10], " ", nn, " levels")), list(nn=drugname)),
     xlab=bquote(log[10]~.(tempstr[1])))
     
dev.off()

# Generate vector of lower part of age intervals here
maxdrugval = quantile(data_DDIfilt[,drugcol], probs=0.97)
saturbins = seq(0, maxdrugval, length.out=numgroups)

list_logratios = vector(mode="list", length=length(saturbins)) # store values
satur_Npats = c()
satur_Nobs = c()
satur_LQRs = c()
satur_UQRs = c()
satur_meds = c()
satur_means = c()
satur_stds = c()
satur_stds_norm = c()
for (i in 1:length(saturbins)) {
  # Iterate through each age group and grab 95% interval values
  if(i < length(saturbins)) {
    data_currsaturbin = data_DDIfilt[which(data_DDIfilt[,drugcol]>saturbins[i] & data_DDIfilt[,drugcol]<saturbins[i+1]),]
  } else {
    data_currsaturbin = data_DDIfilt[which(data_DDIfilt[,drugcol]>saturbins[i]),]
  }
  satur_Npats = c(satur_Npats, length(unique(data_currsaturbin$Patient_ID)))
  satur_Nobs = c(satur_Nobs, nrow(data_currsaturbin))
  satur_means = c(satur_means, mean(data_currsaturbin$logratios))
  satur_meds = c(satur_meds, median(data_currsaturbin$logratios))
  satur_LQRs = c(satur_LQRs, quantile(data_currsaturbin$logratios, probs=0.25))
  satur_UQRs = c(satur_UQRs, quantile(data_currsaturbin$logratios, probs=0.75))
  satur_stds = c(satur_stds, sd(data_currsaturbin$logratios))
  satur_stds_norm = c(satur_stds_norm, sd(exp(data_currsaturbin$logratios)))
  list_logratios[[i]] = data_currsaturbin$logratios
}

# Generate plot of intervals across ages
listDF = data.frame(lapply(rev(list_logratios),"length<-", max(lengths(list_logratios))),
                    check.names = FALSE) # fill blanks with NA
# Generate vector of names
saturnames = c()
for (j in 1:length(saturbins)) {
  if (j < length(saturbins)) {
    saturnames = c(saturnames, paste(as.character(round(saturbins[j],0)), as.character(round(saturbins[j+1],0)), sep="-"))
  } else {
    saturnames = c(saturnames, paste(as.character(round(saturbins[j],0)), "+", sep=""))
  }
}

tiff(gsub("Markdown_files", "",here("Boxplots_satur", paste(savestr,"_box_satur.tiff",sep=""))),
    width=7.25,height=4.5,units="in", res=400)

tempstr = c(paste(titlestr,"ratios"))
par(cex.lab=0.85, cex.main=0.92, mar=c(6.1, 8, 4.1, 3.1), cex.axis=0.7)
boxplot.matrix(as.matrix(listDF), outline = FALSE, notch = TRUE, las=TRUE,
               names=rev(saturnames),
                main=substitute(bold(paste("Boxplots of ", log[10], " ", nn, " ratios versus saturation levels")), list(nn=titlestr)),
               #main=paste("Boxplots of log",titlestr,"ratios versus saturation levels"), 
               boxwex=0.85, xlab=bquote(log[10]~.(tempstr[1])), horizontal=TRUE,
               border = rep(c("darkorchid4"), length(saturbins)),
               col = rep(c("darkorchid3"),length(saturbins)))
title(ylab="Drug saturation level", mgp=c(4.5,1,0))

dev.off()

# Create 95% CIs for difference in means from established baseline bin
saturbaselines <- read.csv(gsub("Markdown_files", "", here("SaturationBaselines.csv")), header=TRUE)
saturind = which(saturbaselines[ ,"Name"]==titlestr)
baselinebin = saturbaselines[saturind, "BinNum"]
saturCIs = c()
for (i in 1:length(list_logratios)){
  if (i == baselinebin) { # Our baseline
    saturCIs = c(saturCIs, "NA")
  } else {
  tobj = t.test(list_logratios[[baselinebin]], list_logratios[[i]], var.equal = FALSE)
  saturCIs = c(saturCIs, paste("(",tobj$conf.int[1]," , ",tobj$conf.int[2],")",sep=""))
  }
}

# Reverse order of DDInames, Npats and Nobsv from above (to match boxplot)
tablenames = saturnames
Npatient = satur_Npats
Nobserv = satur_Nobs
meds = satur_meds
means = satur_means
LQRs = satur_LQRs
UQRs = satur_UQRs
stds = satur_stds
stds_norm = satur_stds_norm

dt_log = data.table(
  Name = tablenames,
  Median = round(meds,4),
  Mean = round(means,4),
  StDev = round(stds,4),
  LQ = round(LQRs,4),
  UQ = round(UQRs,4),
  N_patients = Npatient,
  N_observations = Nobserv,
  saturCIs
)

dt_norm = data.table(
  Name = tablenames,
  Median = round(exp(meds),4),
  Mean = round(exp(means),4),
  StDev = round(stds_norm,4),
  LQ = round(exp(LQRs),4),
  UQ = round(exp(UQRs),4),
  N_patients = Npatient,
  N_observations = Nobserv
)

write.csv(dt_log, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_satur", paste(savestr,".csv",sep=""))))

write.csv(dt_norm, row.names = FALSE, 
          file=gsub("Markdown_files", "",here("Tables_satur", paste(savestr,"_norm.csv",sep=""))))

```








